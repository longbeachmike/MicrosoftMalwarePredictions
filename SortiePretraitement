select DefaultBrowsersIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #dbi from DSGP.dbo.train group by DefaultBrowsersIdentifier
select AVProductStatesIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #avpsi from DSGP.dbo.train group by AVProductStatesIdentifier
select CountryIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #ci from DSGP.dbo.train group by CountryIdentifier
select OrganizationIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #oi from DSGP.dbo.train group by OrganizationIdentifier
select OsBuildLab, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #obl from DSGP.dbo.train group by OsBuildLab order by prop asc
select Census_OEMNameIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #c_oNI from DSGP.dbo.train group by Census_OEMNameIdentifier order by prop asc
select Census_ProcessorModelIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #c_pmi from DSGP.dbo.train group by Census_ProcessorModelIdentifier order by prop asc
select Census_OSInstallLanguageIdentifier, sum(HasDetections) as Nb ,COUNT(*) as nbtot, round(cast( sum(HasDetections) as float)/cast(COUNT(*) as float),2) as prop into #c_oili from DSGP.dbo.train group by Census_OSInstallLanguageIdentifier order by prop asc


select 
	ProductName, -- (2)
	substring(EngineVersion,1,6) as EngineVersion, --(3)
	substring(AppVersion,1,3) as AppVersion, --(4)
	substring(AvSigVersion,1,3) as AvSigVersion, --(5)
	IsBeta, --(6)
	isnull(RtpStateBitfield,0) as RtpStateBitfield, --(7) 
	IsSxsPassiveMode, --(8)
	#dbi.prop as DefaultBrowsersIdentifier, --(9)
	#avpsi.prop as AVProductStatesIdentifier, --(10)
	AVProductsInstalled, --(11)
	AVProductsEnabled, --(12)
	#ci.prop as CountryIdentifier,  --(14)
	#oi.prop as OrganizationIdentifier,  --(16)
	[PLATFORM] as [Platform], --(19)
	Processor, --(20)
	substring(OsVer,1,3) as OsVer, --(21)
	substring(cast(OsBuild as varchar(max)),1,2) as OsBuild, --(22)
	substring(cast(OsSuite as varchar(max)),1,2) as OsSuite, --(23)
	upper(OsPlatformSubRelease) as OsPlatformSubRelease, --(24)
	#obl.prop as OsBuildLab, --(25)
	upper(SkuEdition) as SkuEdition, --(26)
	IsProtected, --(27)
	upper(case 
			when SmartScreen in ('&#x01;','&#x02;','&#x03;') then 'Adresse'
			when SmartScreen in ('00000000','0','Off') then 'Off'
			when SmartScreen in ('Prompt','Promt') then 'Prompt'
			when SmartScreen = ' ' then 'Inconnue'
			else SmartScreen
			end) as SmartScreen, --(32)
	FireWall, --(33)
	case 
		when Census_MDC2FormFactor in ('AllInOne','Desktop','Notebook','Convertible','PCOther') then 'PC'
		when Census_MDC2FormFactor not in ('AllInOne','Desktop','Notebook','Convertible','PCOther') then 'TABLETSERVER'
	End as  Census_MDC2FormFactor, --(35)
	#c_oNI.prop as Census_OEMNameIdentifier, --(37)
	case when Census_ProcessorCoreCount = 0 then 4 else Census_ProcessorCoreCount end as Census_ProcessorCoreCount, --(38)
	#c_pmi.prop as Census_ProcessorModelIdentifier, --(41)
	case when Census_PrimaryDiskTotalCapacity <= 0 then 3016211.52 else CAST(Census_PrimaryDiskTotalCapacity as float) end as Census_PrimaryDiskTotalCapacity, --(43)
	case when Census_systemVolumeTotalCapacity <= 0 then 377341.85 else CAST(Census_systemVolumeTotalCapacity as float) end as Census_systemVolumeTotalCapacity, --(45)
	Census_HasOpticalDiskDrive, --(46)
	case when Census_TotalPhysicalRAM <= 0 then 6115.71 else CAST(Census_TotalPhysicalRAM as float) end as Census_TotalPhysicalRAM, --(47)
	case when cast(Census_InternalPrimaryDiagonalDisplaySizeInInches AS float) <= 0 then  16.68 else CAST(Census_InternalPrimaryDiagonalDisplaySizeInInches as float) end as Census_InternalPrimaryDiagonalDisplaySizeInInches, --(49)
	case when Census_InternalPrimaryDisplayResolutionHorizontal <= 0 then  1547.79 else CAST(Census_InternalPrimaryDisplayResolutionHorizontal as float) end as Census_InternalPrimaryDisplayResolutionHorizontal, --(50)
	case when Census_InternalPrimaryDisplayResolutionVertical <= 0 then  897.61 else CAST(Census_InternalPrimaryDisplayResolutionVertical as float) end as Census_InternalPrimaryDisplayResolutionVertical, --(51)
	upper(case 
		when Census_PowerPlatformRoleName in (' ','Unspecified','UNKNOWN') then 'Inconnu' 
		else cast(Census_PowerPlatformRoleName as varchar(max)) end) as Census_PowerPlatformRoleName, --(52)
	log(Census_InternalBatteryNumberOfCharges+1) as Census_InternalBatteryNumberOfCharges, --(54)
	substring(Census_OSEdition,1,3) as Census_OSEdition, --(60)
	upper(case 
		when Census_OSInstallTypeName in ('Clean','CleanPCRefresh','IBSClean') then 'Clean' 
		when Census_OSInstallTypeName in ('Update','Upgrade', 'UUPUpgrade') then 'Update'
	else Census_OSInstallTypeName
	end) aS Census_OSInstallTypeName, --(62)
	#c_oili.prop as Census_OSInstallLanguageIdentifier, --(63)
	UPPER(Census_OSWUAutoUpdateOptionsName) as Census_OSWUAutoUpdateOptionsName, --(65)
	upper(case when Census_GenuineStateName = 'TAMPERED' then 'UNKNOWN' else Census_GenuineStateName end) as Census_GenuineStateName, --(67)
	UPPER(Census_ActivationChannel) as Census_ActivationChannel, --(68)
	Census_IsSecureBootEnabled, --(75)
	Census_IsVirtualDevice, --(77)
	Census_IsTouchEnabled, --(78)
	Wdft_IsGamer, --(81)
	Wdft_RegionIdentifier,--(82) 
	HasDetections --(83)
	into DSGP.dbo.[TrainPretraiter]
from DSGP.dbo.train t
	left join #dbi on t.DefaultBrowsersIdentifier = #dbi.DefaultBrowsersIdentifier
	left join #avpsi on t.AVProductStatesIdentifier = #avpsi.AVProductStatesIdentifier
	left join #ci on t.CountryIdentifier = #ci.CountryIdentifier
	left join #oi on t.OrganizationIdentifier = #oi.OrganizationIdentifier
	left join #obl on t.OsBuildLab = #obl.OsBuildLab
	left join #c_oNI on t.Census_OEMNameIdentifier = #c_oNI.Census_OEMNameIdentifier
	left join #c_pmi on t.Census_ProcessorModelIdentifier = #c_pmi.Census_ProcessorModelIdentifier
	left join #c_oili on t.Census_OSInstallLanguageIdentifier = #c_oili.Census_OSInstallLanguageIdentifier
